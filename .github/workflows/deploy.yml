name: Deploy Headset Agent (Dual Path)

on:
  push:
    branches:
      - main
      - 'release/*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'prod'
        type: choice
        options:
          - prod
      deploy_lex_path:
        description: 'Deploy Lex Path (A)'
        type: boolean
        default: true
      deploy_nova_sonic_path:
        description: 'Deploy Nova Sonic Path (B)'
        type: boolean
        default: true
      skip_agents:
        description: 'Skip Bedrock agent creation'
        type: boolean
        default: false

env:
  AWS_REGION: us-east-1
  GO_VERSION: '1.23'
  PYTHON_VERSION: '3.11'

jobs:
  setup:
    name: Setup Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      deploy_lex: ${{ steps.set-env.outputs.deploy_lex }}
      deploy_nova_sonic: ${{ steps.set-env.outputs.deploy_nova_sonic }}
    steps:
      - name: Determine environment
        id: set-env
        run: |
          # Single environment: prod
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
            echo "deploy_lex=${{ github.event.inputs.deploy_lex_path }}" >> $GITHUB_OUTPUT
            echo "deploy_nova_sonic=${{ github.event.inputs.deploy_nova_sonic_path }}" >> $GITHUB_OUTPUT
          else
            echo "environment=prod" >> $GITHUB_OUTPUT
            echo "deploy_lex=true" >> $GITHUB_OUTPUT
            echo "deploy_nova_sonic=true" >> $GITHUB_OUTPUT
          fi

  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest
    needs: setup
    outputs:
      aws_account_id: ${{ steps.get-account.outputs.account_id }}
    steps:
      - name: Check required secrets
        run: |
          missing=""
          [ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" ] && missing="$missing AWS_ACCESS_KEY_ID"
          [ -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ] && missing="$missing AWS_SECRET_ACCESS_KEY"

          if [ -n "$missing" ]; then
            echo "Missing required secrets:$missing"
            exit 1
          fi
          echo "All required secrets are configured"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get AWS Account ID
        id: get-account
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "account_id=$ACCOUNT_ID" >> $GITHUB_OUTPUT
          echo "AWS Account ID: $ACCOUNT_ID"

  build:
    name: Build & Test
    runs-on: ubuntu-latest
    needs: [setup, validate]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Go dependencies
        run: |
          go mod download
          go mod tidy

      - name: Run Go tests
        run: |
          go test -v -race -coverprofile=coverage.out ./...
          go tool cover -func=coverage.out

      - name: Build Lex Lambda (Path A)
        if: needs.setup.outputs.deploy_lex == 'true'
        run: |
          GOOS=linux GOARCH=arm64 CGO_ENABLED=0 go build \
            -ldflags="-s -w" \
            -o cmd/lex-lambda/bootstrap \
            ./cmd/lex-lambda/

      - name: Build Nova Sonic Lambda (Path B)
        if: needs.setup.outputs.deploy_nova_sonic == 'true'
        run: |
          GOOS=linux GOARCH=arm64 CGO_ENABLED=0 go build \
            -ldflags="-s -w" \
            -o cmd/nova-sonic-lambda/bootstrap \
            ./cmd/nova-sonic-lambda/

      - name: Upload Lex Lambda artifact
        if: needs.setup.outputs.deploy_lex == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: lex-lambda-binary
          path: cmd/lex-lambda/bootstrap

      - name: Upload Nova Sonic Lambda artifact
        if: needs.setup.outputs.deploy_nova_sonic == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: nova-sonic-lambda-binary
          path: cmd/nova-sonic-lambda/bootstrap

  deploy-sam:
    name: Deploy SAM Stack
    runs-on: ubuntu-latest
    needs: [setup, validate, build]
    environment: ${{ needs.setup.outputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Lex Lambda artifact
        if: needs.setup.outputs.deploy_lex == 'true'
        uses: actions/download-artifact@v4
        with:
          name: lex-lambda-binary
          path: cmd/lex-lambda/

      - name: Download Nova Sonic Lambda artifact
        if: needs.setup.outputs.deploy_nova_sonic == 'true'
        uses: actions/download-artifact@v4
        with:
          name: nova-sonic-lambda-binary
          path: cmd/nova-sonic-lambda/

      - name: Make binaries executable
        run: |
          chmod +x cmd/lex-lambda/bootstrap 2>/dev/null || true
          chmod +x cmd/nova-sonic-lambda/bootstrap 2>/dev/null || true

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Set up SAM CLI
        uses: aws-actions/setup-sam@v2

      - name: Create SAM S3 bucket
        run: |
          BUCKET_NAME="headset-agent-sam-${{ needs.validate.outputs.aws_account_id }}-${{ env.AWS_REGION }}"
          aws s3api head-bucket --bucket "$BUCKET_NAME" 2>/dev/null || \
          aws s3 mb "s3://$BUCKET_NAME" --region ${{ env.AWS_REGION }}

      - name: SAM Build
        run: sam build --template infrastructure/template.yaml

      - name: Check for existing Connect instance
        id: connect
        run: |
          # Show which AWS account we're working in
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "AWS Account ID: $ACCOUNT_ID"

          # List ALL Connect instances to see what exists
          echo "Listing all Connect instances in this account..."
          aws connect list-instances --output table || echo "No instances found or error listing"

          # Look for Connect instance with alias "headset"
          CONNECT_ALIAS="headset"
          echo ""
          echo "Looking for Connect instance with alias: $CONNECT_ALIAS"

          EXISTING_INSTANCE=$(aws connect list-instances \
            --query "InstanceSummaryList[?InstanceAlias=='${CONNECT_ALIAS}' && InstanceStatus=='ACTIVE'].Id | [0]" \
            --output text 2>/dev/null || echo "None")

          if [ "$EXISTING_INSTANCE" != "None" ] && [ -n "$EXISTING_INSTANCE" ]; then
            # Double-verify instance is actually accessible
            echo "Found instance ID: $EXISTING_INSTANCE - verifying it exists..."
            INSTANCE_STATUS=$(aws connect describe-instance --instance-id "$EXISTING_INSTANCE" \
              --query 'Instance.InstanceStatus' --output text 2>/dev/null || echo "ERROR")

            if [ "$INSTANCE_STATUS" == "ACTIVE" ]; then
              # Get the instance ARN to fully verify
              INSTANCE_ARN=$(aws connect describe-instance --instance-id "$EXISTING_INSTANCE" \
                --query 'Instance.Arn' --output text 2>/dev/null || echo "")
              echo "Verified Connect instance: $EXISTING_INSTANCE"
              echo "  Status: $INSTANCE_STATUS"
              echo "  ARN: $INSTANCE_ARN"
              echo "instance_id=$EXISTING_INSTANCE" >> $GITHUB_OUTPUT
            else
              echo "Connect instance $EXISTING_INSTANCE verification failed (status: $INSTANCE_STATUS)"
              echo "Will create a new instance instead"
              echo "instance_id=" >> $GITHUB_OUTPUT
            fi
          else
            echo "No existing Connect instance found with alias: $CONNECT_ALIAS"
            echo "CloudFormation will create a new instance"
            echo "instance_id=" >> $GITHUB_OUTPUT
          fi

      - name: Clean up stack if Connect instance is invalid
        run: |
          ENV="${{ needs.setup.outputs.environment }}"
          STACK_NAME="agent-headset-${ENV}"
          EXISTING_CONNECT="${{ steps.connect.outputs.instance_id }}"

          empty_s3_buckets() {
            # Find and empty all S3 buckets in the stack
            echo "Finding S3 buckets in stack..."
            BUCKETS=$(aws cloudformation describe-stack-resources --stack-name "$STACK_NAME" \
              --query "StackResources[?ResourceType=='AWS::S3::Bucket'].PhysicalResourceId" \
              --output text 2>/dev/null || echo "")

            for BUCKET in $BUCKETS; do
              if [ -n "$BUCKET" ] && [ "$BUCKET" != "None" ]; then
                echo "Emptying S3 bucket: $BUCKET"
                # Delete all object versions (required for versioned buckets)
                aws s3api list-object-versions --bucket "$BUCKET" --output json 2>/dev/null | \
                  jq -r '.Versions[]? | "\(.Key)\t\(.VersionId)"' | \
                  while IFS=$'\t' read -r key version; do
                    [ -n "$key" ] && aws s3api delete-object --bucket "$BUCKET" --key "$key" --version-id "$version" 2>/dev/null || true
                  done
                # Delete all delete markers
                aws s3api list-object-versions --bucket "$BUCKET" --output json 2>/dev/null | \
                  jq -r '.DeleteMarkers[]? | "\(.Key)\t\(.VersionId)"' | \
                  while IFS=$'\t' read -r key version; do
                    [ -n "$key" ] && aws s3api delete-object --bucket "$BUCKET" --key "$key" --version-id "$version" 2>/dev/null || true
                  done
                # Also try simple delete for non-versioned objects
                aws s3 rm "s3://$BUCKET" --recursive 2>/dev/null || true
                echo "Bucket $BUCKET emptied"
              fi
            done
          }

          delete_stack() {
            # First, empty any S3 buckets in the stack
            empty_s3_buckets

            echo "Deleting stack $STACK_NAME..."
            aws cloudformation delete-stack --stack-name "$STACK_NAME"
            echo "Waiting for stack deletion to complete..."
            aws cloudformation wait stack-delete-complete --stack-name "$STACK_NAME" || true

            # Check if deletion actually succeeded
            FINAL_STATUS=$(aws cloudformation describe-stacks --stack-name "$STACK_NAME" \
              --query 'Stacks[0].StackStatus' --output text 2>/dev/null || echo "DOES_NOT_EXIST")

            if [ "$FINAL_STATUS" == "DOES_NOT_EXIST" ]; then
              echo "Stack deleted successfully"
              return 0
            elif [ "$FINAL_STATUS" == "DELETE_FAILED" ]; then
              echo "Stack deletion failed. Attempting to identify stuck resources..."
              # Get resources that failed to delete
              aws cloudformation describe-stack-resources --stack-name "$STACK_NAME" \
                --query "StackResources[?ResourceStatus=='DELETE_FAILED'].[LogicalResourceId,ResourceType,ResourceStatusReason]" \
                --output table || true

              # Try emptying S3 buckets again and retry deletion
              echo "Retrying with bucket cleanup..."
              empty_s3_buckets
              aws cloudformation delete-stack --stack-name "$STACK_NAME"
              sleep 30
              aws cloudformation wait stack-delete-complete --stack-name "$STACK_NAME" || true

              RETRY_STATUS=$(aws cloudformation describe-stacks --stack-name "$STACK_NAME" \
                --query 'Stacks[0].StackStatus' --output text 2>/dev/null || echo "DOES_NOT_EXIST")

              if [ "$RETRY_STATUS" == "DOES_NOT_EXIST" ]; then
                echo "Stack deleted successfully on retry"
                return 0
              else
                echo "ERROR: Stack still exists in state: $RETRY_STATUS"
                echo "Manual intervention may be required"
                exit 1
              fi
            else
              echo "Stack still exists in unexpected state: $FINAL_STATUS"
              return 1
            fi
          }

          # Check if stack exists
          STACK_STATUS=$(aws cloudformation describe-stacks --stack-name "$STACK_NAME" \
            --query 'Stacks[0].StackStatus' --output text 2>/dev/null || echo "DOES_NOT_EXIST")

          echo "Current stack status: $STACK_STATUS"

          if [ "$STACK_STATUS" == "ROLLBACK_COMPLETE" ] || [ "$STACK_STATUS" == "DELETE_FAILED" ] || [ "$STACK_STATUS" == "UPDATE_ROLLBACK_COMPLETE" ]; then
            echo "Stack $STACK_NAME is in $STACK_STATUS state."
            delete_stack
          elif [ "$STACK_STATUS" == "DOES_NOT_EXIST" ]; then
            echo "Stack does not exist, proceeding with fresh deployment"
          elif [ -z "$EXISTING_CONNECT" ]; then
            # No Connect instance found, but stack exists - check if stack references an invalid instance
            STACK_CONNECT_ID=$(aws cloudformation describe-stacks --stack-name "$STACK_NAME" \
              --query "Stacks[0].Outputs[?OutputKey=='ConnectInstanceId'].OutputValue | [0]" \
              --output text 2>/dev/null || echo "")

            if [ -n "$STACK_CONNECT_ID" ] && [ "$STACK_CONNECT_ID" != "None" ]; then
              # Verify the Connect instance still exists
              INSTANCE_STATUS=$(aws connect describe-instance --instance-id "$STACK_CONNECT_ID" \
                --query 'Instance.InstanceStatus' --output text 2>/dev/null || echo "NOT_FOUND")

              if [ "$INSTANCE_STATUS" != "ACTIVE" ]; then
                echo "Stack references Connect instance $STACK_CONNECT_ID which is $INSTANCE_STATUS"
                echo "Deleting stack to allow fresh deployment with new Connect instance..."
                delete_stack
              else
                echo "Stack references valid Connect instance: $STACK_CONNECT_ID"
              fi
            else
              echo "Stack exists but no Connect instance ID found in outputs"
            fi
          else
            echo "Stack exists in state: $STACK_STATUS (using Connect instance: $EXISTING_CONNECT)"
          fi

      - name: SAM Deploy
        id: deploy
        run: |
          ENV="${{ needs.setup.outputs.environment }}"
          STACK_NAME="agent-headset-${ENV}"
          EXISTING_CONNECT="${{ steps.connect.outputs.instance_id }}"

          # Build parameter overrides
          PARAMS="Environment=$ENV"
          PARAMS="$PARAMS KBBucketName=headset-kb-${{ needs.validate.outputs.aws_account_id }}"
          PARAMS="$PARAMS DeployLexPath=${{ needs.setup.outputs.deploy_lex }}"
          PARAMS="$PARAMS DeployNovaSonicPath=${{ needs.setup.outputs.deploy_nova_sonic }}"

          # Add existing Connect instance ID if found
          if [ -n "$EXISTING_CONNECT" ]; then
            echo "Using existing Connect instance: $EXISTING_CONNECT"
            PARAMS="$PARAMS ExistingConnectInstanceId=$EXISTING_CONNECT"
          fi

          sam deploy \
            --template-file .aws-sam/build/template.yaml \
            --stack-name "$STACK_NAME" \
            --s3-bucket "headset-agent-sam-${{ needs.validate.outputs.aws_account_id }}-${{ env.AWS_REGION }}" \
            --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM \
            --no-fail-on-empty-changeset \
            --parameter-overrides $PARAMS

          echo "Stack deployment complete: $STACK_NAME"

  sync-knowledge-base:
    name: Sync Knowledge Base
    runs-on: ubuntu-latest
    needs: [setup, validate, deploy-sam]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Sync KB documents to S3
        run: |
          ENV="${{ needs.setup.outputs.environment }}"
          BUCKET="headset-kb-${{ needs.validate.outputs.aws_account_id }}-${ENV}"

          aws s3 sync knowledge-base/ "s3://${BUCKET}/" \
            --exclude ".git/*" \
            --exclude ".DS_Store" \
            --delete

  deploy-personas:
    name: Deploy Personas
    runs-on: ubuntu-latest
    needs: [setup, deploy-sam]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy persona configurations
        run: |
          ENV="${{ needs.setup.outputs.environment }}"
          TABLE="PersonaConfigurations-${ENV}"

          for persona_file in personas/*.json; do
            echo "Deploying persona: $persona_file"
            aws dynamodb put-item \
              --table-name "$TABLE" \
              --item file://"$persona_file"
          done

  create-agents:
    name: Create Bedrock Agents
    runs-on: ubuntu-latest
    needs: [setup, deploy-sam]
    if: github.event.inputs.skip_agents != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python dependencies
        run: pip install boto3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Create Bedrock agents
        run: |
          python scripts/create-agents.py \
            --environment "${{ needs.setup.outputs.environment }}" \
            --region "${{ env.AWS_REGION }}" \
            --model-provider anthropic

  configure-nova-sonic:
    name: Configure Nova Sonic
    runs-on: ubuntu-latest
    needs: [setup, deploy-sam, create-agents]
    if: needs.setup.outputs.deploy_lex == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python dependencies
        run: pip install boto3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Configure Nova Sonic for Lex
        run: |
          python scripts/configure-nova-sonic.py \
            --environment "${{ needs.setup.outputs.environment }}" \
            --region "${{ env.AWS_REGION }}" \
            --persona tangerine \
            --voice-engine generative

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [setup, deploy-sam, deploy-personas, create-agents]
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install test dependencies
        run: pip install boto3 pytest

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Run integration tests
        run: |
          export ENVIRONMENT="${{ needs.setup.outputs.environment }}"
          pytest tests/integration/ -v --tb=short || true

  setup-connect:
    name: Setup Amazon Connect
    runs-on: ubuntu-latest
    needs: [setup, deploy-sam, create-agents]
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: pip install boto3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Clear stale phone number SSM parameters
        run: |
          ENV="${{ needs.setup.outputs.environment }}"
          echo "Checking for stale phone number configurations..."

          # Get current phone numbers from SSM
          LEX_PHONE=$(aws ssm get-parameter --name "/headset-agent/${ENV}/connect/phone-number-lex" \
            --query 'Parameter.Value' --output text 2>/dev/null || echo "")
          NOVA_PHONE=$(aws ssm get-parameter --name "/headset-agent/${ENV}/connect/phone-number-nova-sonic" \
            --query 'Parameter.Value' --output text 2>/dev/null || echo "")

          # Get Connect instance
          INSTANCE_ID=$(aws ssm get-parameter --name "/headset-agent/${ENV}/connect/instance-id" \
            --query 'Parameter.Value' --output text 2>/dev/null || echo "")

          if [ -n "$INSTANCE_ID" ] && [ "$INSTANCE_ID" != "None" ]; then
            # Check if Lex phone exists and is valid
            if [ -n "$LEX_PHONE" ] && [ "$LEX_PHONE" != "PLACEHOLDER" ] && [ "$LEX_PHONE" != "PENDING" ]; then
              # Verify phone number is actually claimed in Connect
              TARGET_ARN="arn:aws:connect:${{ env.AWS_REGION }}:$(aws sts get-caller-identity --query Account --output text):instance/${INSTANCE_ID}"
              PHONE_EXISTS=$(aws connect list-phone-numbers-v2 --target-arn "$TARGET_ARN" \
                --query "ListPhoneNumbersSummaryList[?PhoneNumber=='${LEX_PHONE}'].PhoneNumber" \
                --output text 2>/dev/null || echo "")

              if [ -z "$PHONE_EXISTS" ]; then
                echo "Lex phone number $LEX_PHONE not found in Connect - clearing SSM parameter"
                aws ssm delete-parameter --name "/headset-agent/${ENV}/connect/phone-number-lex" 2>/dev/null || true
              fi
            fi

            # Check if Nova phone exists and is valid
            if [ -n "$NOVA_PHONE" ] && [ "$NOVA_PHONE" != "PLACEHOLDER" ] && [ "$NOVA_PHONE" != "PENDING" ]; then
              TARGET_ARN="arn:aws:connect:${{ env.AWS_REGION }}:$(aws sts get-caller-identity --query Account --output text):instance/${INSTANCE_ID}"
              PHONE_EXISTS=$(aws connect list-phone-numbers-v2 --target-arn "$TARGET_ARN" \
                --query "ListPhoneNumbersSummaryList[?PhoneNumber=='${NOVA_PHONE}'].PhoneNumber" \
                --output text 2>/dev/null || echo "")

              if [ -z "$PHONE_EXISTS" ]; then
                echo "Nova Sonic phone number $NOVA_PHONE not found in Connect - clearing SSM parameter"
                aws ssm delete-parameter --name "/headset-agent/${ENV}/connect/phone-number-nova-sonic" 2>/dev/null || true
              fi
            fi
          fi

          echo "Phone number parameter check complete"

      - name: List existing phone numbers in Connect
        run: |
          ENV="${{ needs.setup.outputs.environment }}"

          # Get Connect instance ID
          INSTANCE_ID=$(aws ssm get-parameter --name "/headset-agent/${ENV}/connect/instance-id" \
            --query 'Parameter.Value' --output text 2>/dev/null || echo "")

          if [ -n "$INSTANCE_ID" ] && [ "$INSTANCE_ID" != "None" ]; then
            echo "=== Existing Phone Numbers in Connect Instance ==="
            echo "Instance ID: $INSTANCE_ID"
            echo ""

            # List all phone numbers
            aws connect list-phone-numbers \
              --instance-id "$INSTANCE_ID" \
              --query 'PhoneNumberSummaryList[*].{Phone:PhoneNumber,Type:PhoneNumberType,Status:PhoneNumberCountryCode}' \
              --output table 2>/dev/null || echo "No phone numbers found or unable to list"

            echo ""
            echo "To release unused phone numbers:"
            echo "1. Go to AWS Console â†’ Amazon Connect â†’ Phone numbers"
            echo "2. Select unused numbers and release them"
            echo ""
          fi

      - name: Setup Connect resources
        run: |
          python scripts/setup-connect.py \
            --environment "${{ needs.setup.outputs.environment }}" \
            --region "${{ env.AWS_REGION }}"

      - name: Verify contact flow configuration
        run: |
          ENV="${{ needs.setup.outputs.environment }}"

          # Get Connect instance ID
          INSTANCE_ID=$(aws ssm get-parameter --name "/headset-agent/${ENV}/connect/instance-id" \
            --query 'Parameter.Value' --output text 2>/dev/null || echo "")

          if [ -n "$INSTANCE_ID" ] && [ "$INSTANCE_ID" != "None" ]; then
            echo "=== Contact Flow Configuration Check ==="
            echo "Instance ID: $INSTANCE_ID"
            echo ""

            # List contact flows and their IDs
            echo "Contact flows in instance:"
            aws connect list-contact-flows --instance-id "$INSTANCE_ID" \
              --contact-flow-types CONTACT_FLOW \
              --query 'ContactFlowSummaryList[*].[Name,Id,ContactFlowState]' \
              --output table 2>/dev/null || echo "Could not list contact flows"

            # Get and display Lex contact flow content for debugging
            LEX_FLOW_ID=$(aws connect list-contact-flows --instance-id "$INSTANCE_ID" \
              --contact-flow-types CONTACT_FLOW \
              --query "ContactFlowSummaryList[?contains(Name, 'Lex')].Id | [0]" \
              --output text 2>/dev/null || echo "")

            if [ -n "$LEX_FLOW_ID" ] && [ "$LEX_FLOW_ID" != "None" ]; then
              echo ""
              echo "=== Lex Contact Flow Content (checking for KVS references) ==="
              FLOW_CONTENT=$(aws connect describe-contact-flow --instance-id "$INSTANCE_ID" \
                --contact-flow-id "$LEX_FLOW_ID" --query 'ContactFlow.Content' --output text 2>/dev/null || echo "{}")

              # Check for KVS/media streaming references
              if echo "$FLOW_CONTENT" | grep -qi "kinesis\|kvs\|mediastream\|StartMediaStreaming"; then
                echo "WARNING: Contact flow contains media streaming/KVS references!"
                echo "This may cause 'KVS Lambda trigger' errors."
                echo "Consider recreating the contact flow from CloudFormation."
              else
                echo "No KVS/media streaming references found in Lex contact flow."
              fi
            fi
          fi

  validate-deployment:
    name: Validate Deployment
    runs-on: ubuntu-latest
    needs: [setup, deploy-sam, deploy-personas, create-agents, sync-knowledge-base, setup-connect]
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Validate Lambda functions
        run: |
          ENV="${{ needs.setup.outputs.environment }}"

          # Test Lex Lambda
          if [ "${{ needs.setup.outputs.deploy_lex }}" == "true" ]; then
            echo "Testing Lex Lambda..."
            aws lambda invoke \
              --function-name "headset-lex-orchestrator-${ENV}" \
              --payload '{"sessionState":{"sessionAttributes":{"test":"true"}}}' \
              --cli-binary-format raw-in-base64-out \
              response.json || echo "Lex Lambda test failed"
            cat response.json
          fi

          # Test Nova Sonic Lambda
          if [ "${{ needs.setup.outputs.deploy_nova_sonic }}" == "true" ]; then
            echo "Testing Nova Sonic Lambda..."
            aws lambda invoke \
              --function-name "headset-nova-sonic-${ENV}" \
              --payload '{"action":"start","sessionId":"test-123"}' \
              --cli-binary-format raw-in-base64-out \
              response.json || echo "Nova Sonic Lambda test failed"
            cat response.json
          fi

      - name: Validate SSM parameters
        run: |
          ENV="${{ needs.setup.outputs.environment }}"

          # Check supervisor agent configuration
          AGENT_ID=$(aws ssm get-parameter --name "/headset-agent/${ENV}/supervisor-agent-id" --query 'Parameter.Value' --output text 2>/dev/null || echo "PLACEHOLDER")

          if [ "$AGENT_ID" == "PLACEHOLDER" ]; then
            echo "WARNING: Supervisor agent not configured yet"
          else
            echo "Supervisor Agent ID: $AGENT_ID"
          fi

      - name: Deployment summary and phone numbers
        run: |
          ENV="${{ needs.setup.outputs.environment }}"
          STACK_NAME="agent-headset-${ENV}"

          # Get phone numbers from SSM
          LEX_PHONE=$(aws ssm get-parameter --name "/headset-agent/${ENV}/connect/phone-number-lex" --query 'Parameter.Value' --output text 2>/dev/null || echo "Not configured")
          NOVA_PHONE=$(aws ssm get-parameter --name "/headset-agent/${ENV}/connect/phone-number-nova-sonic" --query 'Parameter.Value' --output text 2>/dev/null || echo "Not configured")

          # Get Connect instance ID
          INSTANCE_ID=$(aws ssm get-parameter --name "/headset-agent/${ENV}/connect/instance-id" --query 'Parameter.Value' --output text 2>/dev/null || echo "")

          # Get contact flow names
          LEX_FLOW_NAME="HeadsetSupport-Lex-${ENV}"
          NOVA_FLOW_NAME="HeadsetSupport-NovaSonic-${ENV}"

          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                    DEPLOYMENT COMPLETE                          â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  Environment: ${ENV}"
          echo "â•‘  Stack: ${STACK_NAME}"
          echo "â•‘  Connect Instance: ${INSTANCE_ID}"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘                      PHONE NUMBERS                              â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘"
          echo "â•‘  PATH A - Amazon Lex"
          echo "â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          if [ "$LEX_PHONE" != "Not configured" ] && [ "$LEX_PHONE" != "PENDING" ] && [ -n "$LEX_PHONE" ]; then
            echo "â•‘  ðŸ“ž Phone: ${LEX_PHONE}"
          else
            echo "â•‘  ðŸ“ž Phone: Not yet assigned"
          fi
          echo "â•‘  ðŸ¤– Bot: HeadsetTroubleshooterBot-${ENV}"
          echo "â•‘  ðŸ“‹ Flow: ${LEX_FLOW_NAME}"
          echo "â•‘  ðŸ“ Description: Traditional Lex voice bot with Bedrock backend"
          echo "â•‘"
          echo "â•‘  PATH B - Nova Sonic"
          echo "â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          if [ "$NOVA_PHONE" != "Not configured" ] && [ "$NOVA_PHONE" != "PENDING" ] && [ -n "$NOVA_PHONE" ]; then
            echo "â•‘  ðŸ“ž Phone: ${NOVA_PHONE}"
          else
            echo "â•‘  ðŸ“ž Phone: Not yet assigned"
          fi
          echo "â•‘  ðŸ¤– Lambda: headset-nova-sonic-${ENV}"
          echo "â•‘  ðŸ“‹ Flow: ${NOVA_FLOW_NAME}"
          echo "â•‘  ðŸ“ Description: Direct Bedrock streaming with Nova Sonic voice"
          echo "â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          # Verify phone numbers are associated with correct flows
          if [ -n "$INSTANCE_ID" ] && [ "$INSTANCE_ID" != "None" ]; then
            echo "=== Phone Number Associations ==="
            aws connect list-phone-numbers-v2 \
              --target-arn "arn:aws:connect:${{ env.AWS_REGION }}:$(aws sts get-caller-identity --query Account --output text):instance/${INSTANCE_ID}" \
              --query 'ListPhoneNumbersSummaryList[*].[PhoneNumber,PhoneNumberDescription]' \
              --output table 2>/dev/null || echo "Could not list phone number associations"
          fi

  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [setup, build, deploy-sam, create-agents]
    if: failure()
    steps:
      - name: Notify failure
        run: |
          echo "=== DEPLOYMENT FAILED ==="
          echo "Environment: ${{ needs.setup.outputs.environment }}"
          echo ""
          echo "Claude Code Autonomous Recovery Protocol:"
          echo "1. Check the failed job logs above"
          echo "2. Identify the root cause"
          echo "3. Use /fix-pipeline skill for automated remediation"
          echo "4. Push fixes and re-run the pipeline"
