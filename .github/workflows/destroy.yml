name: Destroy All AWS Assets

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment to destroy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
      confirm_destroy:
        description: 'Type "DESTROY" to confirm deletion of all resources'
        required: true
        type: string
      delete_sam_bucket:
        description: 'Also delete SAM deployment bucket'
        required: false
        default: false
        type: boolean

env:
  AWS_REGION: us-east-1

permissions:
  id-token: write
  contents: read

jobs:
  # ============================================================
  # JOB 1: Validate Confirmation
  # ============================================================
  validate:
    name: Validate Destruction Request
    runs-on: ubuntu-latest
    outputs:
      confirmed: ${{ steps.check.outputs.confirmed }}

    steps:
      - name: Verify Confirmation
        id: check
        run: |
          if [ "${{ inputs.confirm_destroy }}" != "DESTROY" ]; then
            echo "::error::Confirmation failed. You must type 'DESTROY' to proceed."
            echo "confirmed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "confirmed=true" >> $GITHUB_OUTPUT
          echo "Destruction confirmed for environment: ${{ inputs.environment }}"

      - name: Display Warning
        run: |
          echo ""
          echo "============================================================"
          echo "  WARNING: DESTRUCTIVE OPERATION"
          echo "============================================================"
          echo ""
          echo "  This will PERMANENTLY DELETE all AWS resources for:"
          echo "  Environment: ${{ inputs.environment }}"
          echo "  Region: ${{ env.AWS_REGION }}"
          echo ""
          echo "  Resources to be deleted:"
          echo "  - Bedrock Agents (supervisor + 3 sub-agents)"
          echo "  - Amazon Connect instance and phone numbers"
          echo "  - Amazon Lex bots"
          echo "  - Lambda functions"
          echo "  - DynamoDB tables"
          echo "  - S3 buckets (knowledge base + website)"
          echo "  - IAM roles"
          echo "  - API Gateway"
          echo "  - SSM parameters"
          echo "  - CloudWatch log groups"
          echo ""
          echo "  THIS ACTION CANNOT BE UNDONE!"
          echo ""
          echo "============================================================"
          echo ""

  # ============================================================
  # JOB 2: Delete Bedrock Agents
  # ============================================================
  delete-bedrock-agents:
    name: Delete Bedrock Agents
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.confirmed == 'true'

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Delete Bedrock Agents
        run: |
          ENV="${{ inputs.environment }}"

          echo "Deleting Bedrock agents for environment: ${ENV}"
          echo ""

          # List of agents to delete
          AGENTS=(
            "TroubleshootingOrchestrator-${ENV}"
            "DiagnosticAgent-${ENV}"
            "PlatformAgent-${ENV}"
            "EscalationAgent-${ENV}"
          )

          for AGENT_NAME in "${AGENTS[@]}"; do
            echo "Looking for agent: ${AGENT_NAME}"

            # Find agent ID by name
            AGENT_ID=$(aws bedrock-agent list-agents \
              --query "agentSummaries[?agentName=='${AGENT_NAME}'].agentId" \
              --output text 2>/dev/null || echo "")

            if [ -n "$AGENT_ID" ] && [ "$AGENT_ID" != "None" ]; then
              echo "  Found agent ID: ${AGENT_ID}"

              # Delete all aliases first
              echo "  Deleting aliases..."
              ALIASES=$(aws bedrock-agent list-agent-aliases \
                --agent-id "$AGENT_ID" \
                --query "agentAliasSummaries[].agentAliasId" \
                --output text 2>/dev/null || echo "")

              for ALIAS_ID in $ALIASES; do
                if [ -n "$ALIAS_ID" ] && [ "$ALIAS_ID" != "None" ]; then
                  echo "    Deleting alias: ${ALIAS_ID}"
                  aws bedrock-agent delete-agent-alias \
                    --agent-id "$AGENT_ID" \
                    --agent-alias-id "$ALIAS_ID" 2>/dev/null || true
                fi
              done

              # Wait for aliases to be deleted
              sleep 5

              # Delete the agent
              echo "  Deleting agent: ${AGENT_ID}"
              aws bedrock-agent delete-agent \
                --agent-id "$AGENT_ID" \
                --skip-resource-in-use-check 2>/dev/null || true

              echo "  Agent ${AGENT_NAME} deleted"
            else
              echo "  Agent not found: ${AGENT_NAME}"
            fi
            echo ""
          done

          echo "Bedrock agent cleanup complete"

  # ============================================================
  # JOB 3: Delete Connect Resources
  # ============================================================
  delete-connect:
    name: Delete Connect Resources
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.confirmed == 'true'

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Release Connect Phone Numbers
        run: |
          ENV="${{ inputs.environment }}"
          INSTANCE_ALIAS="headset-support-${ENV}"

          echo "Releasing phone numbers for Connect instance: ${INSTANCE_ALIAS}"

          # Find the Connect instance
          INSTANCE_ID=$(aws connect list-instances \
            --query "InstanceSummaryList[?InstanceAlias=='${INSTANCE_ALIAS}'].Id" \
            --output text 2>/dev/null || echo "")

          if [ -n "$INSTANCE_ID" ] && [ "$INSTANCE_ID" != "None" ]; then
            echo "Found Connect instance: ${INSTANCE_ID}"

            INSTANCE_ARN=$(aws connect list-instances \
              --query "InstanceSummaryList[?InstanceAlias=='${INSTANCE_ALIAS}'].Arn" \
              --output text 2>/dev/null)

            # Get all phone numbers for this instance
            PHONE_IDS=$(aws connect list-phone-numbers-v2 \
              --target-arn "$INSTANCE_ARN" \
              --query "ListPhoneNumbersSummaryList[].PhoneNumberId" \
              --output text 2>/dev/null || echo "")

            for PHONE_ID in $PHONE_IDS; do
              if [ -n "$PHONE_ID" ] && [ "$PHONE_ID" != "None" ]; then
                echo "  Releasing phone number: ${PHONE_ID}"
                aws connect release-phone-number \
                  --phone-number-id "$PHONE_ID" 2>/dev/null || true
              fi
            done

            # Disassociate Lex bots
            echo "Disassociating Lex bots..."
            aws connect list-lex-bots \
              --instance-id "$INSTANCE_ID" \
              --query "LexBots[].LexBot" \
              --output json 2>/dev/null | jq -r '.[] | @base64' | while read bot; do
                BOT_JSON=$(echo "$bot" | base64 -d)
                echo "  Disassociating Lex bot..."
                # Note: Lex bot disassociation happens automatically when instance is deleted
              done || true

            echo "Phone numbers released"
          else
            echo "Connect instance not found: ${INSTANCE_ALIAS}"
          fi

  # ============================================================
  # JOB 4: Empty S3 Buckets
  # ============================================================
  empty-s3-buckets:
    name: Empty S3 Buckets
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.confirmed == 'true'

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Empty S3 Buckets
        run: |
          ENV="${{ inputs.environment }}"
          ACCOUNT_ID="${{ secrets.AWS_ACCOUNT_ID }}"

          echo "Emptying S3 buckets for environment: ${ENV}"

          # List of buckets to empty (before CloudFormation can delete them)
          BUCKETS=(
            "headset-kb-${ACCOUNT_ID}-${ENV}"
            "headset-chat-${ACCOUNT_ID}-${ENV}"
          )

          for BUCKET in "${BUCKETS[@]}"; do
            echo "Checking bucket: ${BUCKET}"

            if aws s3api head-bucket --bucket "$BUCKET" 2>/dev/null; then
              echo "  Emptying bucket: ${BUCKET}"

              # Delete all objects (including versions)
              aws s3 rm "s3://${BUCKET}" --recursive 2>/dev/null || true

              # Delete all object versions (for versioned buckets)
              aws s3api list-object-versions \
                --bucket "$BUCKET" \
                --query '{Objects: Versions[].{Key:Key,VersionId:VersionId}}' \
                --output json 2>/dev/null | \
              jq -c 'select(.Objects != null) | {Objects: .Objects, Quiet: true}' | \
              while read -r DELETE_JSON; do
                if [ "$DELETE_JSON" != "null" ] && [ -n "$DELETE_JSON" ]; then
                  aws s3api delete-objects --bucket "$BUCKET" --delete "$DELETE_JSON" 2>/dev/null || true
                fi
              done

              # Delete all delete markers
              aws s3api list-object-versions \
                --bucket "$BUCKET" \
                --query '{Objects: DeleteMarkers[].{Key:Key,VersionId:VersionId}}' \
                --output json 2>/dev/null | \
              jq -c 'select(.Objects != null) | {Objects: .Objects, Quiet: true}' | \
              while read -r DELETE_JSON; do
                if [ "$DELETE_JSON" != "null" ] && [ -n "$DELETE_JSON" ]; then
                  aws s3api delete-objects --bucket "$BUCKET" --delete "$DELETE_JSON" 2>/dev/null || true
                fi
              done

              echo "  Bucket emptied: ${BUCKET}"
            else
              echo "  Bucket not found: ${BUCKET}"
            fi
          done

          echo "S3 bucket cleanup complete"

  # ============================================================
  # JOB 5: Delete CloudFormation Stack
  # ============================================================
  delete-cloudformation:
    name: Delete CloudFormation Stack
    runs-on: ubuntu-latest
    needs: [validate, delete-bedrock-agents, delete-connect, empty-s3-buckets]
    if: needs.validate.outputs.confirmed == 'true'

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Delete CloudFormation Stack
        run: |
          ENV="${{ inputs.environment }}"
          STACK_NAME="headset-agent-stack-${ENV}"

          echo "Deleting CloudFormation stack: ${STACK_NAME}"

          # Check if stack exists
          STACK_STATUS=$(aws cloudformation describe-stacks \
            --stack-name "$STACK_NAME" \
            --query "Stacks[0].StackStatus" \
            --output text 2>/dev/null || echo "NOT_FOUND")

          if [ "$STACK_STATUS" != "NOT_FOUND" ]; then
            echo "Stack found with status: ${STACK_STATUS}"

            # Delete the stack
            aws cloudformation delete-stack --stack-name "$STACK_NAME"

            echo "Waiting for stack deletion (this may take several minutes)..."

            # Wait for stack deletion with timeout
            TIMEOUT=1800  # 30 minutes
            ELAPSED=0
            INTERVAL=30

            while [ $ELAPSED -lt $TIMEOUT ]; do
              STATUS=$(aws cloudformation describe-stacks \
                --stack-name "$STACK_NAME" \
                --query "Stacks[0].StackStatus" \
                --output text 2>/dev/null || echo "DELETED")

              if [ "$STATUS" = "DELETED" ] || [ "$STATUS" = "" ]; then
                echo "Stack deleted successfully"
                break
              elif [ "$STATUS" = "DELETE_FAILED" ]; then
                echo "::error::Stack deletion failed!"

                # Show failed resources
                echo "Failed resources:"
                aws cloudformation describe-stack-resources \
                  --stack-name "$STACK_NAME" \
                  --query "StackResources[?ResourceStatus=='DELETE_FAILED'].[LogicalResourceId,ResourceType,ResourceStatusReason]" \
                  --output table 2>/dev/null || true

                exit 1
              fi

              echo "  Status: ${STATUS} (${ELAPSED}s elapsed)"
              sleep $INTERVAL
              ELAPSED=$((ELAPSED + INTERVAL))
            done

            if [ $ELAPSED -ge $TIMEOUT ]; then
              echo "::warning::Stack deletion timed out. Check AWS Console for status."
            fi
          else
            echo "Stack not found: ${STACK_NAME}"
          fi

  # ============================================================
  # JOB 6: Cleanup SSM Parameters
  # ============================================================
  cleanup-ssm:
    name: Cleanup SSM Parameters
    runs-on: ubuntu-latest
    needs: [validate, delete-cloudformation]
    if: needs.validate.outputs.confirmed == 'true'

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Delete SSM Parameters
        run: |
          ENV="${{ inputs.environment }}"
          PREFIX="/headset-agent/${ENV}/"

          echo "Deleting SSM parameters with prefix: ${PREFIX}"

          # Get all parameters with the prefix
          PARAMS=$(aws ssm get-parameters-by-path \
            --path "$PREFIX" \
            --recursive \
            --query "Parameters[].Name" \
            --output text 2>/dev/null || echo "")

          for PARAM in $PARAMS; do
            if [ -n "$PARAM" ] && [ "$PARAM" != "None" ]; then
              echo "  Deleting: ${PARAM}"
              aws ssm delete-parameter --name "$PARAM" 2>/dev/null || true
            fi
          done

          echo "SSM parameter cleanup complete"

  # ============================================================
  # JOB 7: Delete SAM Deployment Bucket (Optional)
  # ============================================================
  delete-sam-bucket:
    name: Delete SAM Bucket
    runs-on: ubuntu-latest
    needs: [validate, delete-cloudformation]
    if: needs.validate.outputs.confirmed == 'true' && inputs.delete_sam_bucket == true

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Delete SAM Deployment Bucket
        run: |
          ACCOUNT_ID="${{ secrets.AWS_ACCOUNT_ID }}"
          BUCKET_NAME="headset-agent-sam-${ACCOUNT_ID}-${{ env.AWS_REGION }}"

          echo "Deleting SAM deployment bucket: ${BUCKET_NAME}"

          if aws s3api head-bucket --bucket "$BUCKET_NAME" 2>/dev/null; then
            echo "Emptying bucket..."
            aws s3 rm "s3://${BUCKET_NAME}" --recursive 2>/dev/null || true

            # Delete versions
            aws s3api list-object-versions \
              --bucket "$BUCKET_NAME" \
              --query '{Objects: Versions[].{Key:Key,VersionId:VersionId}}' \
              --output json 2>/dev/null | \
            jq -c 'select(.Objects != null) | {Objects: .Objects, Quiet: true}' | \
            while read -r DELETE_JSON; do
              if [ "$DELETE_JSON" != "null" ] && [ -n "$DELETE_JSON" ]; then
                aws s3api delete-objects --bucket "$BUCKET_NAME" --delete "$DELETE_JSON" 2>/dev/null || true
              fi
            done

            echo "Deleting bucket..."
            aws s3api delete-bucket --bucket "$BUCKET_NAME" 2>/dev/null || true
            echo "SAM bucket deleted"
          else
            echo "SAM bucket not found: ${BUCKET_NAME}"
          fi

  # ============================================================
  # JOB 8: Cleanup CloudWatch Logs
  # ============================================================
  cleanup-logs:
    name: Cleanup CloudWatch Logs
    runs-on: ubuntu-latest
    needs: [validate, delete-cloudformation]
    if: needs.validate.outputs.confirmed == 'true'

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Delete CloudWatch Log Groups
        run: |
          ENV="${{ inputs.environment }}"

          echo "Deleting CloudWatch log groups for environment: ${ENV}"

          # Log groups that might remain after stack deletion
          LOG_GROUPS=(
            "/aws/lambda/headset-agent-orchestrator-${ENV}"
            "/aws/lex/HeadsetTroubleshooterBot-${ENV}"
          )

          for LOG_GROUP in "${LOG_GROUPS[@]}"; do
            echo "Checking log group: ${LOG_GROUP}"

            if aws logs describe-log-groups \
              --log-group-name-prefix "$LOG_GROUP" \
              --query "logGroups[?logGroupName=='${LOG_GROUP}'].logGroupName" \
              --output text 2>/dev/null | grep -q "$LOG_GROUP"; then

              echo "  Deleting: ${LOG_GROUP}"
              aws logs delete-log-group --log-group-name "$LOG_GROUP" 2>/dev/null || true
            else
              echo "  Not found: ${LOG_GROUP}"
            fi
          done

          echo "CloudWatch log cleanup complete"

  # ============================================================
  # JOB 9: Final Summary
  # ============================================================
  summary:
    name: Destruction Summary
    runs-on: ubuntu-latest
    needs: [validate, delete-bedrock-agents, delete-connect, empty-s3-buckets, delete-cloudformation, cleanup-ssm, cleanup-logs]
    if: always() && needs.validate.outputs.confirmed == 'true'

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify Cleanup
        run: |
          ENV="${{ inputs.environment }}"
          STACK_NAME="headset-agent-stack-${ENV}"

          echo ""
          echo "============================================================"
          echo "  DESTRUCTION SUMMARY"
          echo "============================================================"
          echo ""
          echo "Environment: ${ENV}"
          echo "Region: ${{ env.AWS_REGION }}"
          echo ""

          # Check if stack still exists
          STACK_STATUS=$(aws cloudformation describe-stacks \
            --stack-name "$STACK_NAME" \
            --query "Stacks[0].StackStatus" \
            --output text 2>/dev/null || echo "DELETED")

          if [ "$STACK_STATUS" = "DELETED" ] || [ -z "$STACK_STATUS" ]; then
            echo "CloudFormation Stack: DELETED"
          else
            echo "CloudFormation Stack: ${STACK_STATUS} (may still be in progress)"
          fi

          # Check for remaining Bedrock agents
          REMAINING_AGENTS=$(aws bedrock-agent list-agents \
            --query "agentSummaries[?contains(agentName, '${ENV}')].agentName" \
            --output text 2>/dev/null || echo "")

          if [ -z "$REMAINING_AGENTS" ] || [ "$REMAINING_AGENTS" = "None" ]; then
            echo "Bedrock Agents: DELETED"
          else
            echo "Bedrock Agents: Some may remain - ${REMAINING_AGENTS}"
          fi

          # Check SSM parameters
          REMAINING_PARAMS=$(aws ssm get-parameters-by-path \
            --path "/headset-agent/${ENV}/" \
            --recursive \
            --query "Parameters[].Name" \
            --output text 2>/dev/null || echo "")

          if [ -z "$REMAINING_PARAMS" ] || [ "$REMAINING_PARAMS" = "None" ]; then
            echo "SSM Parameters: DELETED"
          else
            echo "SSM Parameters: Some may remain"
          fi

          echo ""
          echo "============================================================"
          echo ""
          echo "Destruction complete for environment: ${ENV}"
          echo ""
          echo "Note: Some resources may take additional time to fully delete."
          echo "Check the AWS Console to verify all resources are removed."
          echo ""
          echo "============================================================"
