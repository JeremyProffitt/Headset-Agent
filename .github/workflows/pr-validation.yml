name: PR Validation

on:
  pull_request:
    branches:
      - main
      - 'release/*'

env:
  GO_VERSION: '1.22'

jobs:
  # ============================================================
  # Lint and Format Check
  # ============================================================
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Check Go Modules
        run: |
          go mod download
          go mod verify

      - name: Check Formatting
        run: |
          echo "ðŸ” Checking code formatting..."
          UNFORMATTED=$(gofmt -l .)
          if [ -n "$UNFORMATTED" ]; then
            echo "âŒ The following files are not formatted:"
            echo "$UNFORMATTED"
            echo ""
            echo "Run 'gofmt -w .' to fix formatting"
            exit 1
          fi
          echo "âœ… Code formatting is correct"

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
          args: --timeout=5m
        continue-on-error: true

  # ============================================================
  # Unit Tests
  # ============================================================
  test:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run Tests
        run: |
          echo "ðŸ§ª Running unit tests..."
          go test -v -race -coverprofile=coverage.out ./... || true

      - name: Check Coverage
        run: |
          if [ -f coverage.out ]; then
            echo "ðŸ“Š Coverage report:"
            go tool cover -func=coverage.out
          fi

  # ============================================================
  # Build Verification
  # ============================================================
  build:
    name: Build Verification
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Build Lambda Binary
        run: |
          echo "ðŸ”¨ Building Lambda binary..."
          GOOS=linux GOARCH=arm64 CGO_ENABLED=0 go build \
            -ldflags="-s -w" \
            -o bootstrap \
            ./cmd/lambda/

          echo "âœ… Build successful"
          ls -la bootstrap

  # ============================================================
  # SAM Template Validation
  # ============================================================
  validate-template:
    name: Validate SAM Template
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup SAM CLI
        uses: aws-actions/setup-sam@v2
        with:
          use-installer: true

      - name: Validate Template
        run: |
          echo "ðŸ” Validating SAM template..."
          sam validate --template infrastructure/template.yaml --lint
          echo "âœ… SAM template is valid"

  # ============================================================
  # Security Scan
  # ============================================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run Gosec Security Scanner
        run: |
          echo "ðŸ”’ Running security scan..."
          go install github.com/securego/gosec/v2/cmd/gosec@latest
          gosec -quiet ./... || true
          echo "âœ… Security scan complete"

  # ============================================================
  # Validate Persona Files
  # ============================================================
  validate-personas:
    name: Validate Persona Files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Validate JSON Syntax
        run: |
          echo "ðŸ” Validating persona JSON files..."

          for file in personas/*.json; do
            echo "  Checking: $file"
            if ! python -m json.tool "$file" > /dev/null 2>&1; then
              echo "âŒ Invalid JSON in $file"
              exit 1
            fi
          done

          echo "âœ… All persona files are valid JSON"

      - name: Verify Required Personas
        run: |
          echo "ðŸ” Verifying required personas exist..."

          REQUIRED_PERSONAS=("tangerine" "joseph" "jennifer")

          for persona in "${REQUIRED_PERSONAS[@]}"; do
            if [ ! -f "personas/${persona}.json" ]; then
              echo "âŒ Missing required persona: ${persona}"
              exit 1
            fi
            echo "  âœ“ ${persona}.json"
          done

          echo "âœ… All required personas present"

  # ============================================================
  # PR Summary
  # ============================================================
  summary:
    name: PR Summary
    runs-on: ubuntu-latest
    needs: [lint, test, build, validate-template, security, validate-personas]
    if: always()

    steps:
      - name: Generate Summary
        run: |
          echo "## PR Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.lint.result }}" == "success" ]; then
            echo "| Lint & Format | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Lint & Format | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.test.result }}" == "success" ]; then
            echo "| Unit Tests | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Unit Tests | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.build.result }}" == "success" ]; then
            echo "| Build | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Build | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.validate-template.result }}" == "success" ]; then
            echo "| SAM Template | âœ… Valid |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| SAM Template | âŒ Invalid |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.security.result }}" == "success" ]; then
            echo "| Security | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Security | âš ï¸ Issues |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.validate-personas.result }}" == "success" ]; then
            echo "| Personas | âœ… Valid |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Personas | âŒ Invalid |" >> $GITHUB_STEP_SUMMARY
          fi
