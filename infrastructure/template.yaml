AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Headset Support Agent - Voice-based troubleshooting with programmable personas

Globals:
  Function:
    Timeout: 30
    MemorySize: 256
    Runtime: provided.al2023
    Architectures:
      - arm64
    Environment:
      Variables:
        LOG_LEVEL: !Ref LogLevel

Parameters:
  Environment:
    Type: String
    Default: dev
    AllowedValues:
      - dev
      - staging
      - prod
    Description: Deployment environment

  SupervisorAgentName:
    Type: String
    Default: TroubleshootingOrchestrator
    Description: Name of the Bedrock supervisor agent

  KBBucketName:
    Type: String
    Description: S3 bucket name for knowledge base documents

  PersonaTableName:
    Type: String
    Default: PersonaConfigurations
    Description: DynamoDB table name for persona configurations

  LexBotName:
    Type: String
    Default: HeadsetTroubleshooterBot
    Description: Name of the Lex V2 bot

  BedrockModelSupervisor:
    Type: String
    Default: anthropic.claude-3-5-sonnet-20241022-v2:0
    Description: Foundation model for supervisor agent

  BedrockModelSubagent:
    Type: String
    Default: anthropic.claude-3-5-haiku-20241022-v1:0
    Description: Foundation model for sub-agents (cost optimized)

  LogLevel:
    Type: String
    Default: INFO
    AllowedValues:
      - DEBUG
      - INFO
      - WARN
      - ERROR

  DefaultPersona:
    Type: String
    Default: tangerine
    AllowedValues:
      - tangerine
      - joseph
      - jennifer

Conditions:
  IsProd: !Equals [!Ref Environment, prod]

Resources:
  # =============================================================
  # S3 BUCKET FOR KNOWLEDGE BASE
  # =============================================================
  KnowledgeBaseBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "${KBBucketName}-${Environment}"
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: HeadsetSupportAgent

  # =============================================================
  # DYNAMODB TABLE FOR PERSONAS
  # =============================================================
  PersonaTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "${PersonaTableName}-${Environment}"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: persona_id
          AttributeType: S
      KeySchema:
        - AttributeName: persona_id
          KeyType: HASH
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: !If [IsProd, true, false]
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: HeadsetSupportAgent

  # =============================================================
  # DYNAMODB TABLE FOR SESSION STATE
  # =============================================================
  SessionTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "HeadsetAgentSessions-${Environment}"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: session_id
          AttributeType: S
      KeySchema:
        - AttributeName: session_id
          KeyType: HASH
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true
      Tags:
        - Key: Environment
          Value: !Ref Environment

  # =============================================================
  # LAMBDA FUNCTION - LEX FULFILLMENT
  # =============================================================
  TroubleshootingFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: makefile
    Properties:
      FunctionName: !Sub "headset-agent-orchestrator-${Environment}"
      Handler: bootstrap
      CodeUri: ../cmd/lambda/
      Description: Headset troubleshooting agent - Lex fulfillment handler
      Environment:
        Variables:
          ENVIRONMENT: !Ref Environment
          PERSONA_TABLE_NAME: !Ref PersonaTable
          SESSION_TABLE_NAME: !Ref SessionTable
          KB_BUCKET_NAME: !Ref KnowledgeBaseBucket
          SUPERVISOR_AGENT_ID_PARAM: !Sub "/headset-agent/${Environment}/supervisor-agent-id"
          SUPERVISOR_AGENT_ALIAS_PARAM: !Sub "/headset-agent/${Environment}/supervisor-agent-alias"
          DEFAULT_PERSONA: !Ref DefaultPersona
          BEDROCK_MODEL_SUPERVISOR: !Ref BedrockModelSupervisor
          BEDROCK_MODEL_SUBAGENT: !Ref BedrockModelSubagent
      Policies:
        - Version: '2012-10-17'
          Statement:
            - Sid: BedrockAccess
              Effect: Allow
              Action:
                - bedrock:InvokeAgent
                - bedrock:InvokeModel
                - bedrock:RetrieveAndGenerate
                - bedrock:Retrieve
              Resource: '*'
            - Sid: DynamoDBAccess
              Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:PutItem
                - dynamodb:UpdateItem
                - dynamodb:Query
              Resource:
                - !GetAtt PersonaTable.Arn
                - !GetAtt SessionTable.Arn
            - Sid: S3Access
              Effect: Allow
              Action:
                - s3:GetObject
                - s3:ListBucket
              Resource:
                - !GetAtt KnowledgeBaseBucket.Arn
                - !Sub "${KnowledgeBaseBucket.Arn}/*"
            - Sid: SSMAccess
              Effect: Allow
              Action:
                - ssm:GetParameter
              Resource:
                - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/headset-agent/${Environment}/*"
            - Sid: PollyAccess
              Effect: Allow
              Action:
                - polly:SynthesizeSpeech
              Resource: '*'
      Events:
        LexInvocation:
          Type: CloudWatchEvent
          Properties:
            Pattern:
              source:
                - aws.lex
      Tags:
        Environment: !Ref Environment
        Project: HeadsetSupportAgent

  # Lambda permission for Lex
  LexInvocationPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref TroubleshootingFunction
      Action: lambda:InvokeFunction
      Principal: lexv2.amazonaws.com
      SourceArn: !Sub "arn:aws:lex:${AWS::Region}:${AWS::AccountId}:bot-alias/*"

  # =============================================================
  # IAM ROLE FOR BEDROCK AGENTS
  # =============================================================
  BedrockAgentRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "BedrockAgentRole-${Environment}"
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: bedrock.amazonaws.com
            Action: sts:AssumeRole
            Condition:
              StringEquals:
                aws:SourceAccount: !Ref AWS::AccountId
      Policies:
        - PolicyName: BedrockAgentPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: InvokeModel
                Effect: Allow
                Action:
                  - bedrock:InvokeModel
                  - bedrock:InvokeModelWithResponseStream
                Resource:
                  - !Sub "arn:aws:bedrock:${AWS::Region}::foundation-model/${BedrockModelSupervisor}"
                  - !Sub "arn:aws:bedrock:${AWS::Region}::foundation-model/${BedrockModelSubagent}"
              - Sid: KnowledgeBase
                Effect: Allow
                Action:
                  - bedrock:Retrieve
                  - bedrock:RetrieveAndGenerate
                Resource: '*'
              - Sid: S3KnowledgeBase
                Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:ListBucket
                Resource:
                  - !GetAtt KnowledgeBaseBucket.Arn
                  - !Sub "${KnowledgeBaseBucket.Arn}/*"
              - Sid: LambdaInvoke
                Effect: Allow
                Action:
                  - lambda:InvokeFunction
                Resource:
                  - !GetAtt TroubleshootingFunction.Arn
      Tags:
        - Key: Environment
          Value: !Ref Environment

  # =============================================================
  # IAM ROLE FOR LEX BOT
  # =============================================================
  LexServiceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "LexServiceRole-${Environment}"
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lexv2.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: LexServicePolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - polly:SynthesizeSpeech
                Resource: '*'
              - Effect: Allow
                Action:
                  - lambda:InvokeFunction
                Resource:
                  - !GetAtt TroubleshootingFunction.Arn

  # =============================================================
  # CLOUDWATCH LOG GROUP
  # =============================================================
  LambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${TroubleshootingFunction}"
      RetentionInDays: !If [IsProd, 90, 14]

  # =============================================================
  # LEX V2 BOT
  # =============================================================
  HeadsetTroubleshooterBot:
    Type: AWS::Lex::Bot
    Properties:
      Name: !Sub "${LexBotName}-${Environment}"
      Description: Voice-based headset troubleshooting assistant
      RoleArn: !GetAtt LexServiceRole.Arn
      DataPrivacy:
        ChildDirected: false
      IdleSessionTTLInSeconds: 300
      AutoBuildBotLocales: true
      BotLocales:
        - LocaleId: en_US
          NluConfidenceThreshold: 0.40
          VoiceSettings:
            VoiceId: Joanna
            Engine: neural
          Intents:
            - Name: TroubleshootIntent
              Description: Main troubleshooting intent
              SampleUtterances:
                - Utterance: "my headset is not working"
                - Utterance: "I can't hear anything"
                - Utterance: "the microphone is broken"
                - Utterance: "help me fix my headset"
                - Utterance: "audio problems"
                - Utterance: "no sound"
                - Utterance: "bluetooth won't connect"
                - Utterance: "headset won't pair"
                - Utterance: "I need help with my headset"
                - Utterance: "troubleshoot my headphones"
              FulfillmentCodeHook:
                Enabled: true
              DialogCodeHook:
                Enabled: true
            - Name: FallbackIntent
              Description: Fallback when no intent matches
              ParentIntentSignature: "AMAZON.FallbackIntent"
              FulfillmentCodeHook:
                Enabled: true
      BotTags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: HeadsetSupportAgent

  HeadsetBotVersion:
    Type: AWS::Lex::BotVersion
    Properties:
      BotId: !Ref HeadsetTroubleshooterBot
      BotVersionLocaleSpecification:
        - LocaleId: en_US
          BotVersionLocaleDetails:
            SourceBotVersion: DRAFT

  HeadsetBotAlias:
    Type: AWS::Lex::BotAlias
    Properties:
      BotId: !Ref HeadsetTroubleshooterBot
      BotAliasName: !Sub "live-${Environment}"
      BotVersion: !GetAtt HeadsetBotVersion.BotVersion
      BotAliasLocaleSettings:
        - LocaleId: en_US
          BotAliasLocaleSetting:
            Enabled: true
            CodeHookSpecification:
              LambdaCodeHook:
                CodeHookInterfaceVersion: "1.0"
                LambdaArn: !GetAtt TroubleshootingFunction.Arn

  # =============================================================
  # AMAZON CONNECT INSTANCE
  # =============================================================
  ConnectInstance:
    Type: AWS::Connect::Instance
    Properties:
      InstanceAlias: !Sub "headset-support-${Environment}"
      IdentityManagementType: CONNECT_MANAGED
      Attributes:
        InboundCalls: true
        OutboundCalls: false
        ContactflowLogs: true
        AutoResolveBestVoices: true
        UseCustomTTSVoices: false
        EarlyMedia: true

  # =============================================================
  # CONNECT INTEGRATION ASSOCIATION (Lex Bot)
  # =============================================================
  ConnectLexIntegration:
    Type: AWS::Connect::IntegrationAssociation
    Properties:
      InstanceId: !Ref ConnectInstance
      IntegrationType: LEX_BOT
      IntegrationArn: !GetAtt HeadsetBotAlias.Arn

  # =============================================================
  # CONNECT CONTACT FLOW
  # =============================================================
  HeadsetSupportContactFlow:
    Type: AWS::Connect::ContactFlow
    DependsOn: ConnectLexIntegration
    Properties:
      InstanceArn: !GetAtt ConnectInstance.Arn
      Name: !Sub "HeadsetSupport-${Environment}"
      Type: CONTACT_FLOW
      Description: Main contact flow for headset troubleshooting
      Content: !Sub
        - |
          {
            "Version": "2019-10-30",
            "StartAction": "welcome-prompt",
            "Metadata": {
              "entryPointPosition": {"x": 20, "y": 20}
            },
            "Actions": [
              {
                "Identifier": "welcome-prompt",
                "Type": "MessageParticipant",
                "Parameters": {
                  "Text": "Welcome to Headset Support. I'm here to help you troubleshoot your headset. Please describe the issue you're experiencing."
                },
                "Transitions": {
                  "NextAction": "get-customer-input",
                  "Errors": [
                    {"NextAction": "disconnect", "ErrorType": "NoMatchingError"}
                  ]
                }
              },
              {
                "Identifier": "get-customer-input",
                "Type": "ConnectParticipantWithLexBot",
                "Parameters": {
                  "LexV2Bot": {
                    "AliasArn": "${BotAliasArn}"
                  }
                },
                "Transitions": {
                  "NextAction": "disconnect",
                  "Errors": [
                    {"NextAction": "error-handler", "ErrorType": "NoMatchingError"},
                    {"NextAction": "error-handler", "ErrorType": "NoMatchingCondition"}
                  ]
                }
              },
              {
                "Identifier": "error-handler",
                "Type": "MessageParticipant",
                "Parameters": {
                  "Text": "I'm sorry, I'm having trouble understanding. Let me transfer you to a human agent."
                },
                "Transitions": {
                  "NextAction": "disconnect",
                  "Errors": [
                    {"NextAction": "disconnect", "ErrorType": "NoMatchingError"}
                  ]
                }
              },
              {
                "Identifier": "disconnect",
                "Type": "DisconnectParticipant",
                "Parameters": {},
                "Transitions": {}
              }
            ]
          }
        - BotAliasArn: !GetAtt HeadsetBotAlias.Arn
      Tags:
        - Key: Environment
          Value: !Ref Environment

  # =============================================================
  # CONNECT PHONE NUMBER
  # =============================================================
  ConnectPhoneNumber:
    Type: AWS::Connect::PhoneNumber
    DependsOn: HeadsetSupportContactFlow
    Properties:
      TargetArn: !GetAtt ConnectInstance.Arn
      Type: DID
      CountryCode: US
      Description: !Sub "Headset Support Line - ${Environment}"
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: HeadsetSupportAgent

  # =============================================================
  # SSM PARAMETERS (Placeholders - Updated by agent creation script)
  # =============================================================
  SupervisorAgentIdParam:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/headset-agent/${Environment}/supervisor-agent-id"
      Type: String
      Value: "PLACEHOLDER"
      Description: Bedrock Supervisor Agent ID (updated by create-agents script)

  SupervisorAgentAliasParam:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/headset-agent/${Environment}/supervisor-agent-alias"
      Type: String
      Value: "PLACEHOLDER"
      Description: Bedrock Supervisor Agent Alias (updated by create-agents script)

Outputs:
  LambdaFunctionArn:
    Description: ARN of the Lambda function
    Value: !GetAtt TroubleshootingFunction.Arn
    Export:
      Name: !Sub "${AWS::StackName}-LambdaArn"

  LambdaFunctionName:
    Description: Name of the Lambda function
    Value: !Ref TroubleshootingFunction

  KnowledgeBaseBucketName:
    Description: S3 bucket for knowledge base documents
    Value: !Ref KnowledgeBaseBucket
    Export:
      Name: !Sub "${AWS::StackName}-KBBucket"

  PersonaTableName:
    Description: DynamoDB table for persona configurations
    Value: !Ref PersonaTable
    Export:
      Name: !Sub "${AWS::StackName}-PersonaTable"

  SessionTableName:
    Description: DynamoDB table for session state
    Value: !Ref SessionTable

  BedrockAgentRoleArn:
    Description: IAM role ARN for Bedrock agents
    Value: !GetAtt BedrockAgentRole.Arn
    Export:
      Name: !Sub "${AWS::StackName}-BedrockAgentRole"

  LexServiceRoleArn:
    Description: IAM role ARN for Lex bot
    Value: !GetAtt LexServiceRole.Arn
    Export:
      Name: !Sub "${AWS::StackName}-LexServiceRole"

  LexBotId:
    Description: Lex V2 Bot ID
    Value: !Ref HeadsetTroubleshooterBot

  LexBotAliasId:
    Description: Lex V2 Bot Alias ID
    Value: !GetAtt HeadsetBotAlias.BotAliasId

  ConnectInstanceId:
    Description: Amazon Connect Instance ID
    Value: !Ref ConnectInstance

  ConnectInstanceArn:
    Description: Amazon Connect Instance ARN
    Value: !GetAtt ConnectInstance.Arn

  ContactFlowArn:
    Description: Contact Flow ARN
    Value: !GetAtt HeadsetSupportContactFlow.ContactFlowArn

  PhoneNumber:
    Description: Phone number for the headset support line
    Value: !GetAtt ConnectPhoneNumber.Address
    Export:
      Name: !Sub "${AWS::StackName}-PhoneNumber"

  PhoneNumberArn:
    Description: Phone number ARN
    Value: !GetAtt ConnectPhoneNumber.PhoneNumberArn
